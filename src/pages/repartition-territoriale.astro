---
import Layout from "../layouts/Layout.astro";
import medecinsEvolution from "../assets/medecins_evolution_annuelle.json";
import medecinsDept from "../assets/medecins_par_departement.json";
import departements from "../assets/departements.geojson.json";

const listeAnnees = [
    "Toutes (2018-2025)",
    ...medecinsEvolution.map((d) => d.annee.toString()),
];
---

<Layout title="Répartition territoriale : fracture métropoles-rural">
    <div class="max-w-7xl mx-auto px-6 py-12">
        <h1 class="text-4xl lg:text-5xl font-extrabold text-purple-900 mb-6">
            Nombre de médecins accrédités par département en France
            Métropolitaine
        </h1>

        <p class="text-lg leading-relaxed text-slate-600 mb-4">
            Cette carte illustre la répartition géographique des médecins
            accrédités en France Métropolitaine de 2018 à 2025.
        </p>

        <p class="text-lg leading-relaxed text-slate-600 mb-8">
            Cette carte révèle une forte concentration des médecins accrédités
            dans les grandes métropoles françaises.
        </p>
    </div>

    <div class="flex justify-center px-6 mb-6">
        <div class="flex gap-4 items-center">
            <label for="annee" class="font-semibold text-slate-700"
                >Année :</label
            >
            <select
                id="annee"
                class="border border-slate-300 rounded-lg px-4 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-purple-600"
            >
                {
                    listeAnnees.map((a, i) => (
                        <option value={a} selected={i === 0}>
                            {a}
                        </option>
                    ))
                }
            </select>
        </div>
    </div>

    <div class="flex justify-center px-6 mb-12">
        <div
            id="plot-container"
            class="bg-white rounded-2xl border border-slate-200 p-6 inline-block"
        >
        </div>
    </div>

    <div class="text-center mx-auto px-6 mb-12">
        <a
            href="https://www.data.gouv.fr/datasets/medecins-accredites-par-la-has/"
            class="text-sm text-blue-600 hover:text-blue-800 underline"
            target="_blank"
        >
            Source : Médecins accrédités par la HAS
        </a>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <div class="space-y-6">
                <div>
                    <h3 class="text-2xl font-semibold text-purple-900 mb-4">
                        Forte concentration métropolitaine
                    </h3>
                    <p class="text-base leading-relaxed text-slate-700">
                        Les zones rouge foncé (Paris, Lyon, Marseille, Bordeaux)
                        regroupent la majorité des médecins accrédités - Paris
                        compte à lui seul 906 médecins, soit près de 9% du total
                        national.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-purple-900 mb-4">
                        Déserts médicaux
                    </h3>
                    <p class="text-base leading-relaxed text-slate-700">
                        À l'inverse, les territoires ruraux restent désertés :
                        la plupart des départements du centre et de l'est de la
                        France comptent moins de 50 médecins accrédités.
                        Certains départements comme la Lozère, la Creuse ou la
                        Haute-Marne en ont moins de 10.
                    </p>
                </div>

                <div>
                    <h3 class="text-2xl font-semibold text-purple-900 mb-4">
                        Une inégalité structurelle
                    </h3>
                    <p class="text-base leading-relaxed text-slate-700">
                        Cette inégalité géographique reflète la concentration
                        hospitalière et démontre que le système d'accréditation,
                        bien qu'en croissance, reproduit les déséquilibres
                        territoriaux existants en matière de densité médicale.
                    </p>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-2xl p-8">
                <h3 class="text-2xl font-semibold text-purple-900 mb-6">
                    Départements
                </h3>

                <div>
                    <h4 class="text-lg font-semibold text-slate-700 mb-4">
                        Top 5
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700">Paris (75)</span>
                            <span class="text-purple-800 font-bold">906</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700"
                                >Bouches-du-Rhône (13)</span
                            >
                            <span class="text-purple-800 font-bold">675</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700">Rhône (69)</span>
                            <span class="text-purple-800 font-bold">603</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700">Gironde (33)</span>
                            <span class="text-purple-800 font-bold">423</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700"
                                >Hauts-de-Seine (92)</span
                            >
                            <span class="text-purple-800 font-bold">346</span>
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold text-slate-700 mb-4 mt-5">
                        Bas du classement
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700">Lozère (48)</span>
                            <span class="text-purple-800 font-bold">3</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700">Indre (36)</span>
                            <span class="text-purple-800 font-bold">2</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-700">Haute-Marne (52)</span>
                            <span class="text-purple-800 font-bold">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <h3 class="text-2xl font-semibold text-purple-900 mb-4 mt-20">
                Témoignage d'une résidente de Haute Marne
            </h3>
            <div class="bg-white border border-slate-200 rounded-2xl p-8">
                <div>
                    <h4 class="text-lg font-semibold text-slate-700 mb-4">
                        Solène Geiss, 20 ans, étudiante en BUT MMI
                    </h4>
                    <p class="text-slate-700 italic">
                        « Les temps sont difficiles avec les médecins, 6 mois
                        pour un rendez-vous... tous les ans le cabinet change de
                        docteur, on ne sait jamais si le prochain restera ! Pour
                        avoir un rendez-vous avant il faut faire 1/2h de route
                        et pour les spécialistes c'est encore pire ! Le plus
                        proche reste Dijon ou Nancy. »
                    </p>
                </div>
            </div>
        </div>

        <div class="mt-10">
            <a
                href="/conclusion"
                class="text-purple-700 font-medium hover:text-purple-900"
            >
                Lire la conclusion de notre analyse →
            </a>
        </div>
    </div>
</Layout>

<script>
    import * as Plot from "@observablehq/plot";
    import medecinsEvolution from "../assets/medecins_evolution_annuelle.json";
    import medecinsDept from "../assets/medecins_par_departement.json";
    import departements from "../assets/departements.geojson.json";

    const elmAnnee = document.getElementById("annee") as HTMLSelectElement;
    const container = document.getElementById("plot-container");

    function getMedecinsByDept(anneeSelectionnee: string) {
        if (anneeSelectionnee === "Toutes (2018-2025)") {
            return new Map(
                medecinsDept.map((d) => [d.Département, d.nombre_medecins]),
            );
        } else {
            const anneeData = medecinsEvolution.find(
                (d) => d.annee === Number(anneeSelectionnee),
            );
            const totalCumul =
                medecinsEvolution[medecinsEvolution.length - 1].cumul;
            const ratio = anneeData.nombre_accreditations / totalCumul;

            return new Map(
                medecinsDept.map((d) => [
                    d.Département,
                    Math.round(d.nombre_medecins * ratio),
                ]),
            );
        }
    }

    function updateMap() {
        const anneeValue = elmAnnee.value;
        const medecinsByDept = getMedecinsByDept(anneeValue);

        const optionPlot = {
            title: "Nombre cumulé de médecins accrédités par département en France Métropolitaine",
            subtitle: "(de 2018 à 2025)",
            projection: {
                type: "mercator",
                domain: departements,
            },
            color: {
                type: "threshold",
                domain:
                    anneeValue === "Toutes (2018-2025)"
                        ? [0, 50, 100, 200, 300, 500]
                        : [0, 10, 25, 50, 100, 200],
                scheme: "YlOrRd",
                legend: true,
                label: `Nombre de médecins accrédités ${
                    anneeValue === "Toutes (2018-2025)"
                        ? "(cumul 2018-2025)"
                        : `en ${anneeValue}`
                }`,
                tickFormat: (d) => (d === 0 ? "0" : d),
            },
            marks: [
                Plot.geo(departements, {
                    fill: (d) => {
                        const code =
                            d.properties.code ||
                            d.properties.CODE_DEPT ||
                            d.properties.insee;
                        return medecinsByDept.get(code) || 0;
                    },
                    stroke: "white",
                    strokeWidth: 0.5,
                    channels: {
                        Département: (d) => {
                            const code =
                                d.properties.code ||
                                d.properties.CODE_DEPT ||
                                d.properties.insee;
                            return (
                                d.properties.nom ||
                                d.properties.NOM_DEPT ||
                                code
                            );
                        },
                        Code: (d) =>
                            d.properties.code ||
                            d.properties.CODE_DEPT ||
                            d.properties.insee,
                        Médecins: (d) => {
                            const code =
                                d.properties.code ||
                                d.properties.CODE_DEPT ||
                                d.properties.insee;
                            return medecinsByDept.get(code) || 0;
                        },
                    },
                    tip: true,
                }),
            ],
        };

        if (container) {
            container.innerHTML = "";
            const plot = Plot.plot(optionPlot);
            container.appendChild(plot);
        }
    }

    updateMap();

    elmAnnee.addEventListener("change", updateMap);
</script>
